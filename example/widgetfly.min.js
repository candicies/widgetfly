!function(root,factory){"use strict";"function"==typeof define&&define.amd?define([],function(){return root.Widgetfly=factory()}):root.Widgetfly=factory(root)}(this,function(){"use strict";var Widgetfly=function(window){var Widgetfly={};return Widgetfly.Utils=function(){var Utils={has:function(obj,key){return Object.prototype.hasOwnProperty.call(obj,key)},each:function(obj,iterator,context){if(null===obj)return!1;if(Array.prototype.forEach&&obj.forEach===Array.prototype.forEach)obj.forEach(iterator,context);else if("number"==typeof obj.length){for(var i=0,l=obj.length;l>i;i++)if(iterator.call(context,obj[i],i,obj)==={})return!1}else for(var key in obj)if(Widgetfly.Utils.has(obj,key)&&iterator.call(context,obj[key],key,obj)==={})return!1},isEmpty:function(obj){if(null===obj)return!0;if(obj.length>0)return!1;if(0===obj.length)return!0;for(var key in obj)if(hasOwnProperty.call(obj,key))return!1;return!0},extend:function(obj){return this.each(Array.prototype.slice.call(arguments,1),function(source){if(source)for(var prop in source)obj[prop]=source[prop]}),obj},inherit:function(Child,Parent){var F=function(){};F.prototype=Parent.prototype,Child.prototype=new F,Child.prototype.constructor=Child,Child.uber=Parent.prototype},getParameterByName:function(name){name=name.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var regex=new RegExp("[\\#&]"+name+"=([^&#]*)"),results=regex.exec(window.location.hash);return null===results?"":decodeURIComponent(results[1].replace(/\+/g," "))},parseUrl:function(URL,checkLib){var nowSrc,parameter,i,tmpStr,tmpParam,createParam={};if("string"!=typeof URL&&URL.length>0?(URL=URL[URL.length-1],void 0!==URL.getAttribute.length&&(nowSrc=URL.getAttribute("src",-1))):nowSrc=URL,parameter=nowSrc.split("#",2),parameter.length>1&&(parameter=parameter[1],parameter=parameter.split("#"),parameter.length>0&&(parameter[0].split("=",2).length>0&&(createParam.type=parameter[0].split("=",2)[1]),void 0!==parameter[1]&&parameter[1].split("=",2).length>0&&""!==parameter[1].split("=",2)[1]&&(createParam.container=parameter[1].split("=",2)[1],"appendClass"===parameter[1].split("=",2)[0]?(createParam.appendType="class",createParam.dom="."+createParam.container):(createParam.appendType="id",createParam.dom="#"+createParam.container)),parameter.length>2)))for(createParam.options={},i=2;i<parameter.length;i++)parameter[i].split("=",2).length>0&&(tmpParam=parameter[i].split("=",2)[1],tmpParam=tmpParam.split(":"),tmpParam.length>0&&(tmpStr=tmpParam.shift(),0!==tmpParam.length&&(tmpParam=tmpParam.join(":"),""!==tmpParam&&null!==tmpParam&&"null"!==tmpParam&&(createParam.options[tmpStr]=tmpParam))));return void 0===checkLib?createParam:void checkLib(createParam)},genId:function(){var first,i=0,id="",possible1="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",possible2="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(first=possible1.charAt(Math.floor(Math.random()*possible1.length)),i=1;20>i;i++)id+=possible2.charAt(Math.floor(Math.random()*possible2.length));return first+id},getElementsByClassName:function(testClass,startFrom){for(var i=-1,results=[],finder=new RegExp("(?:^|\\s)"+testClass+"(?:\\s|$)"),a=startFrom&&startFrom.getElementsByTagName&&startFrom.getElementsByTagName("*")||document.all||document.getElementsByTagName("*"),l=a.length;++i<l;finder.test(a[i].className)&&results.push(a[i]));return a=null,results},inIframe:function(){try{return window.self!==window.top}catch(e){return!0}},isFunction:function(obj){return"function"==typeof obj},isElement:function(o){return"object"==typeof HTMLElement?o instanceof HTMLElement:o&&"object"==typeof o&&null!==o&&1===o.nodeType&&"string"==typeof o.nodeName},trans2Elem:function(element,startFrom){var target;return target="string"==typeof element?"#"===element.substr(0,1)?document.getElementById(element.replace("#","")):"."===element.substr(0,1)?this.getElementsByClassName(element.replace(".",""),startFrom)[0]:document.getElementsByTagName(element)[0]:element},hasClass:function(element,cls){return(" "+element.className+" ").indexOf(" "+cls+" ")>-1},addClass:function(element,className,startFrom){var target;void 0===startFrom&&(startFrom=document),target=this.trans2Elem(element,startFrom),this.hasClass(target,className)||(target.className+=" "+className)},removeClass:function(element,rmClass,startFrom){var target,newClass;if(void 0===startFrom&&(startFrom=document),target=this.trans2Elem(element,startFrom),void 0!==target&&this.isElement(target)&&(newClass=" "+target.className.replace(/[\t\r\n]/g," ")+" ",this.hasClass(target,rmClass))){for(;newClass.indexOf(" "+rmClass+" ")>=0;)newClass=newClass.replace(" "+rmClass+" "," ");target.className=newClass.replace(/^\s+|\s+$/g,"")}},toggleClass:function(element,className,startFrom){var target,newClass;if(void 0===startFrom&&(startFrom=document),target=this.trans2Elem(element,startFrom),void 0!==target&&this.isElement(target))if(newClass=" "+target.className.replace(/[\t\r\n]/g," ")+" ",this.hasClass(target,className)){for(;newClass.indexOf(" "+className+" ")>=0;)newClass=newClass.replace(" "+className+" "," ");target.className=newClass.replace(/^\s+|\s+$/g,"")}else target.className+=" "+className}};return Utils}(this),Widgetfly.Events=function(){var Events=function(){};return Events.prototype.trigger=function(action,data,targetId,targetOrigin,transfer){Widgetfly.Mediator.send(this.id,action,data,targetId,targetOrigin,transfer)},Events.prototype.on=function(eventName,callback){Widgetfly.Mediator.bind(this.id,eventName,callback)},Events.prototype.off=function(eventName){Widgetfly.Mediator.unbind(this.id,eventName)},Events}(this),Widgetfly.Mediator=function(){var Mediator={widgets:{},widgetEvents:{},mapping:{},init:function(){var self=this;window.addEventListener("message",function(msgObj){self.receive(msgObj)},!1)},getWidget:function(id){return this.widgets[id]},getWidgetEvents:function(id){return this.widgetEvents[id]},register:function(id,widget){this.widgets[widget.id]=widget,this.widgetEvents[widget.id]={}},unregister:function(id,callback){if(void 0!==this.widgetEvents[id]){var self=this;Widgetfly.Utils.each(this.widgetEvents[id],function(key){delete self.widgetEvents[id][key]})}delete this.widgets[id],callback(!0)},send:function(id,action,data){console.log("Events.trigger");var targetOrigin,corsObj={msg:data,action:action,id:id},widget=this.widgets[id];if(widget){var parser=window.document.createElement("a");parser.href=widget.iframe.src,targetOrigin=parser.protocol+"//"+parser.host,widget.iframe.contentWindow.postMessage(corsObj,targetOrigin)}},bind:function(id,eventName,callback){console.log("Events.bind"),void 0===this.widgetEvents[id]&&(this.widgetEvents[id]={}),this.widgetEvents[id][eventName]=callback},unbind:function(id,eventName){console.log("Events.unbind"),delete this.widgetEvents[id][eventName],Object.keys(this.widgetEvents[id]).length<=0&&delete this.widgetEvents[id]},receive:function(msgObj){console.log("Mediator.receive");var widgetId=msgObj.data.id,widget=this.widgets[widgetId],widgetEvents=this.widgetEvents[widgetId],action=msgObj.data.action;if(widget){var origin,parser=window.document.createElement("a");if(parser.href=widget.iframe.src,origin=parser.protocol+"//"+parser.host,origin!==msgObj.origin)return void console.log("Widget ignore message from "+msgObj.origin);widget&&Widgetfly.Utils.isFunction(widget[action])?widget[action](msgObj.data.msg):!Widgetfly.Utils.isEmpty(widgetEvents)&&Widgetfly.Utils.isFunction(widgetEvents[action])&&widgetEvents[action](msgObj.data.msg)}}};return Mediator}(this),Widgetfly.Server=function(){var Server=function(){this.id=window.name,this.events={},this.init()};return Widgetfly.Utils.inherit(Server,Widgetfly.Events),Server.prototype.init=function(){var self=this;this.trigger("start"),window.addEventListener("message",function(msgObj){if(window.parent){var params,paramData=Widgetfly.Utils.getParameterByName("wo");params=JSON.parse(paramData);var origin,parser=window.document.createElement("a");if(parser.href=params.origin,origin=parser.protocol+"//"+parser.host,"file://"!==origin&&origin!==msgObj.origin)return void console.log("Server ignore message from "+msgObj.origin);var action=msgObj.data.action;Widgetfly.Utils.isFunction(self[action])?self[action](msgObj.data.msg):!Widgetfly.Utils.isEmpty(self.events)&&Widgetfly.Utils.isFunction(self.events[action])&&self.events[action](msgObj.data.msg)}},!1)},Server.prototype.on=function(key,callback){this.events[key]=callback},Server.prototype.off=function(key){delete this.events[key]},Server.prototype.trigger=function(action,data){console.log("Server.trigger");var corsObj={msg:data,action:action,id:this.id},params=JSON.parse(Widgetfly.Utils.getParameterByName("wo"));parent.postMessage(corsObj,params.origin)},Server.prototype.show=function(){this.trigger("show")},Server.prototype.hide=function(){this.trigger("hide")},Server.prototype.onClose=function(callback){console.log("Server onClose action"),callback()},Server.prototype.close=function(){console.log("Prepare server close action");var self=this;Widgetfly.Utils.each(this.events,function(key){delete self.events[key]}),this.onClose(function(){console.log("Server close action"),self.trigger("close")})},Server.prototype.setSize=function(width,height){Widgetfly.Events.trigger(window.name,"sizeChange",width,height)},Server}(this),Widgetfly.Widget=function(){var Widget=function(){this.id=Widgetfly.Utils.genId()};return Widgetfly.Utils.inherit(Widget,Widgetfly.Events),Widget.prototype.onStart=function(callback){Widgetfly.Utils.isFunction(callback)&&this.on("onStart",callback)},Widget.prototype.start=function(){console.log("Action onStart");var events=Widgetfly.Mediator.getWidgetEvents(this.id);events&&Widgetfly.Utils.isFunction(events.onStart)&&events.onStart()},Widget.prototype.getId=function(){return this.id},Widget.prototype.onHide=function(callback){Widgetfly.Utils.isFunction(callback)&&this.on("onHide",callback)},Widget.prototype.hide=function(){console.log("action hide"),"id"===this.setting.appendType?window.document.getElementById(this.setting.container).hide():window.document.getElementsByClassName(this.setting.container)[0].hide(),console.log("action onHide");var events=Widgetfly.Mediator.getWidgetEvents(this.id);events&&Widgetfly.Utils.isFunction(events.onHide)&&events.onHide()},Widget.prototype.onShow=function(callback){Widgetfly.Utils.isFunction(callback)&&this.on("onShow",callback)},Widget.prototype.show=function(){var self=this;console.log("action show"),"id"===self.setting.appendType?void 0!==window.document.getElementById(self.setting.container)&&window.document.getElementById(self.setting.container).show():void 0!==window.document.getElementsByClassName(self.setting.container)[0]&&window.document.getElementsByClassName(self.setting.container)[0].show(),console.log("action onShow");var events=Widgetfly.Mediator.getWidgetEvents(this.id);events&&Widgetfly.Utils.isFunction(events.onShow)&&events.onShow()},Widget.prototype.onBeforeClose=function(callback){Widgetfly.Utils.isFunction(callback)&&this.on("onBeforeClose",callback)},Widget.prototype.close=function(){var self=this,events=Widgetfly.Mediator.getWidgetEvents(this.id);events&&Widgetfly.Utils.isFunction(events.onBeforeClose)&&events.onBeforeClose(),Widgetfly.Mediator.unregister(this.id,function(){var removeDom;removeDom="class"===self.setting.appendType?document.getElementsByClassName(self.setting.container)[0]:document.getElementById(self.setting.container),removeDom.parentNode.removeChild(removeDom)})},Widget.prototype.setMap=function(setting){var container=setting.dom;Widgetfly.Mediator.mapping[container]=setting.id},Widget.prototype.register=function(){var nowScripts=document.getElementsByTagName("script"),cScript=nowScripts[nowScripts.length-1];Widgetfly.Mediator.register(this.id,this),cScript.setAttribute("data-id",this.id)},Widget}(this),Widgetfly.Panel=function(){var Panel=function(setting){return Widgetfly.Widget.apply(this,arguments),setting.dom=setting.container,"."===setting.container.substr(0,1)?(setting.appendType="class",setting.container=setting.container.replace(".","")):"#"===setting.container.substr(0,1)&&(setting.appendType="id",setting.container=setting.container.replace("#","")),void 0===setting?!1:(void 0!==setting.options.src&&void 0===setting.container&&void 0!==setting.appendClass&&(setting.appendType="class",setting.dom="."+setting.appendClass,setting.container=setting.appendClass),setting.id=this.id,this.setting=setting,this.setMap(setting),this.register(this.id),setting.options.initRender&&this.render(setting),this)};return Widgetfly.Utils.inherit(Panel,Widgetfly.Widget),Panel.prototype.render=function(setting){var src,origin,urlOptions,iframe=document.createElement("iFrame");origin="file:"===window.location.protocol?window.location.href:window.location.protocol+"//"+window.location.host,urlOptions={origin:origin},iframe.setAttribute("name",setting.id),src=-1===setting.options.src.indexOf("#")?setting.options.src+"#":setting.options.src+"&",src=src+"wo="+decodeURIComponent(JSON.stringify(urlOptions)),iframe.setAttribute("src",src),void 0===setting.container||null===setting.container?Widgetfly.Utils.getElementsByClassName("qt")[0].appendChild(iframe):"id"===setting.appendType?window.document.getElementById(setting.container).length>0&&window.document.getElementById(setting.container).appendChild(iframe):Widgetfly.Utils.getElementsByClassName(setting.container)[0].appendChild(iframe),this.iframe=iframe},Panel}(this),Widgetfly.Modal=function(){var Modal=function(){};return Widgetfly.Utils.inherit(Modal,Widgetfly.Widget),Modal}(this),Widgetfly.Popover=function(){var Popover=function(){};return Widgetfly.Utils.inherit(Popover,Widgetfly.Widget),Popover}(this),function(window){var extend=function(protoProps,staticProps){var child,parent=this;child=protoProps&&Widgetfly.Utils.has(protoProps,"constructor")?protoProps.constructor:function(){return parent.apply(this,arguments)},Widgetfly.Utils.extend(child,parent,staticProps);var Surrogate=function(){this.constructor=child};return Surrogate.prototype=parent.prototype,child.prototype=new Surrogate,protoProps&&Widgetfly.Utils.extend(child.prototype,protoProps),child.__super__=parent.prototype,child};Widgetfly.Panel.extend=Widgetfly.Modal.extend=Widgetfly.Popover.extend=Widgetfly.Server.extend=extend;var instance,nowScripts=document.getElementsByTagName("script"),param=Widgetfly.Utils.parseUrl(nowScripts);Widgetfly.Utils.inIframe()?console.log("Now is Server initialize"):(console.log("Now is Widgets initialize"),Widgetfly.Mediator.init(),Widgetfly.Utils.getElementsByClassName("qt").length<=0&&(instance=window.document.createElement("div"),instance.setAttribute("class","qt"),window.document.getElementsByTagName("body")[0].appendChild(instance)),Widgetfly.Utils.isEmpty(param)||new Widgetfly.Panel(param))}(this),Widgetfly}(this);return Widgetfly});
//# sourceMappingURL=widgetfly.min.map