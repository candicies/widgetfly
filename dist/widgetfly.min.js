!function(root,factory){"use strict";"function"==typeof define&&define.amd?define([],function(){return root.Widgetfly=factory()}):root.Widgetfly=factory(root)}(this,function(){"use strict";var Widgetfly=function(){var Widgetfly={};return Widgetfly.Utils=function(){var idCounter=0,Utils={has:function(obj,key){return Object.prototype.hasOwnProperty.call(obj,key)},each:function(obj,iterator,context){var i,l,key;if(null===obj)return!1;if(Array.prototype.forEach&&obj.forEach===Array.prototype.forEach)obj.forEach(iterator,context);else if("number"==typeof obj.length){for(i=0,l=obj.length;l>i;i++)if(iterator.call(context,obj[i],i,obj)==={})return!1}else for(key in obj)if(Widgetfly.Utils.has(obj,key)&&iterator.call(context,obj[key],key,obj)==={})return!1},isEmpty:function(obj){if(null===obj)return!0;if(obj.length>0)return!1;if(0===obj.length)return!0;for(var key in obj)if(hasOwnProperty.call(obj,key))return!1;return!0},extend:function(obj){return this.each(Array.prototype.slice.call(arguments,1),function(source){if(source)for(var prop in source)obj[prop]=source[prop]}),obj},inherit:function(Child,Parent){var F=function(){};F.prototype=Parent.prototype,Child.prototype=new F,Child.prototype.constructor=Child,Child.uber=Parent.prototype},getParameterByName:function(name){name=name.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var regex=new RegExp("[\\#&]"+name+"=([^&#]*)"),results=regex.exec(window.location.hash);return null===results?"":decodeURIComponent(results[1].replace(/\+/g," "))},parseUrl:function(URL,checkLib){var nowSrc,parameter,i,tmpStr,tmpParam,createParam={};if("string"!=typeof URL&&URL.length>0?(URL=URL[URL.length-1],void 0!==URL.getAttribute.length&&(nowSrc=URL.getAttribute("src",-1))):nowSrc=URL,parameter=nowSrc.split("?",2),parameter.length>1&&(parameter=parameter[1],parameter=parameter.split("?"),parameter.length>0&&(parameter[0].split("=",2).length>0&&(createParam.type=parameter[0].split("=",2)[1]),void 0!==parameter[1]&&parameter[1].split("=",2).length>0&&""!==parameter[1].split("=",2)[1]&&(createParam.container=parameter[1].split("=",2)[1],"appendClass"===parameter[1].split("=",2)[0]?(createParam.appendType="class",createParam.dom="."+createParam.container):(createParam.appendType="id",createParam.dom="#"+createParam.container)),parameter.length>2)))for(createParam.options={},i=2;i<parameter.length;i++)parameter[i].split("=",2).length>0&&(tmpParam=parameter[i].split("=",2)[1],tmpParam=tmpParam.split(":"),tmpParam.length>0&&(tmpStr=tmpParam.shift(),0!==tmpParam.length&&(tmpParam=tmpParam.join(":"),""!==tmpParam&&null!==tmpParam&&"null"!==tmpParam&&(createParam.options[tmpStr]=tmpParam))));return void 0===checkLib?createParam:void checkLib(createParam)},genId:function(){var first,i=0,id="",possible1="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",possible2="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(first=possible1.charAt(Math.floor(Math.random()*possible1.length)),i=1;20>i;i++)id+=possible2.charAt(Math.floor(Math.random()*possible2.length));return first+id},uniqueId:function(prefix){var id=String(++idCounter);return prefix?prefix+id:id},getElementsByClassName:function(testClass,startFrom){for(var i=-1,results=[],finder=new RegExp("(?:^|\\s)"+testClass+"(?:\\s|$)"),a=startFrom&&startFrom.getElementsByTagName&&startFrom.getElementsByTagName("*")||document.all||document.getElementsByTagName("*"),l=a.length;++i<l;finder.test(a[i].className)&&results.push(a[i]));return a=null,results},inIframe:function(){try{return window.self!==window.top}catch(e){return!0}},isFunction:function(obj){return"function"==typeof obj},isElement:function(o){return"object"==typeof HTMLElement?o instanceof HTMLElement:o&&"object"==typeof o&&null!==o&&1===o.nodeType&&"string"==typeof o.nodeName},trans2Elem:function(element,startFrom){var target;return target="string"==typeof element?"#"===element.substr(0,1)?document.getElementById(element.replace("#","")):"."===element.substr(0,1)?this.getElementsByClassName(element.replace(".",""),startFrom)[0]:document.getElementsByTagName(element)[0]:element},hasClass:function(element,cls){return(" "+element.className+" ").indexOf(" "+cls+" ")>-1},addClass:function(element,className,startFrom){var target;void 0===startFrom&&(startFrom=document),target=this.trans2Elem(element,startFrom),this.hasClass(target,className)||(target.className+=" "+className)},removeClass:function(element,rmClass,startFrom){var target,newClass;if(void 0===startFrom&&(startFrom=document),target=this.trans2Elem(element,startFrom),void 0!==target&&this.isElement(target)&&(newClass=" "+target.className.replace(/[\t\r\n]/g," ")+" ",this.hasClass(target,rmClass))){for(;newClass.indexOf(" "+rmClass+" ")>=0;)newClass=newClass.replace(" "+rmClass+" "," ");target.className=newClass.replace(/^\s+|\s+$/g,"")}},toggleClass:function(element,className,startFrom){var target,newClass;if(void 0===startFrom&&(startFrom=document),target=this.trans2Elem(element,startFrom),void 0!==target&&this.isElement(target))if(newClass=" "+target.className.replace(/[\t\r\n]/g," ")+" ",this.hasClass(target,className)){for(;newClass.indexOf(" "+className+" ")>=0;)newClass=newClass.replace(" "+className+" "," ");target.className=newClass.replace(/^\s+|\s+$/g,"")}else target.className+=" "+className}};return Utils}(this),Widgetfly.Events=function(){var Events=function(){};return Events.prototype.trigger=function(action,data){Widgetfly.Mediator.send(this.id,action,data)},Events.prototype.on=function(action,callback){Widgetfly.Mediator.bind(this.id,action,callback)},Events.prototype.off=function(action){Widgetfly.Mediator.unbind(this.id,action)},Events}(this),Widgetfly.Mediator=function(){var Mediator={widgets:{},actionHandlers:{},init:function(){var self=this;window.addEventListener("message",function(msgObj){self.receive(msgObj)},!1)},getWidget:function(id){return this.widgets[id]},getActionHandlers:function(id){return this.actionHandlers[id]},register:function(id,widget){this.widgets[widget.id]=widget,this.actionHandlers[widget.id]={}},unregister:function(id,callback){if(void 0!==this.actionHandlers[id]){var self=this;Widgetfly.Utils.each(this.actionHandlers[id],function(key){delete self.actionHandlers[id][key]})}delete this.widgets[id],callback(!0)},send:function(id,action,data){console.log("Mediator.send");var parser,targetOrigin,corsObj={msg:data,action:action,id:id},widget=this.widgets[id];widget&&(parser=window.document.createElement("a"),parser.href=widget.iframe.src,targetOrigin=parser.protocol+"//"+parser.host,widget.iframe.contentWindow.postMessage(corsObj,targetOrigin))},bind:function(id,action,callback){console.log("Mediator.bind"),void 0===this.actionHandlers[id]&&(this.actionHandlers[id]={}),this.actionHandlers[id][action]=callback},unbind:function(id,action){console.log("Mediator.unbind"),delete this.actionHandlers[id][action],Object.keys(this.actionHandlers[id]).length<=0&&delete this.actionHandlers[id]},receive:function(msgObj){console.log("Mediator.receive");var origin,parser,widgetId=msgObj.data.id,widget=this.widgets[widgetId],myActionHandlers=this.actionHandlers[widgetId],action=msgObj.data.action;if(widget){if(parser=window.document.createElement("a"),parser.href=widget.iframe.src,origin=parser.protocol+"//"+parser.host,origin!==msgObj.origin)return void console.log("Widget ignore message from "+msgObj.origin);widget&&Widgetfly.Utils.isFunction(widget[action])?widget[action](msgObj.data.msg):!Widgetfly.Utils.isEmpty(myActionHandlers)&&Widgetfly.Utils.isFunction(myActionHandlers[action])&&myActionHandlers[action](msgObj.data.msg)}}};return Mediator}(this),Widgetfly.Server=function(){var Server=function(){this.id=window.name,this.events={},this.init()};return Widgetfly.Utils.inherit(Server,Widgetfly.Events),Server.prototype.init=function(){var self=this;this.trigger("start"),window.addEventListener("message",function(msgObj){if(window.parent){var action,origin,parser,params,paramData=Widgetfly.Utils.getParameterByName("wo");if(params=JSON.parse(paramData),parser=window.document.createElement("a"),parser.href=params.origin,origin=parser.protocol+"//"+parser.host,"file://"!==origin&&origin!==msgObj.origin)return void console.log("Server ignore message from "+msgObj.origin);action=msgObj.data.action,Widgetfly.Utils.isFunction(self[action])?self[action](msgObj.data.msg):!Widgetfly.Utils.isEmpty(self.events)&&Widgetfly.Utils.isFunction(self.events[action])&&self.events[action](msgObj.data.msg)}},!1)},Server.prototype.on=function(key,callback){this.events[key]=callback},Server.prototype.off=function(key){delete this.events[key]},Server.prototype.trigger=function(action,data){console.log("Server.trigger");var corsObj={msg:data,action:action,id:this.id},params=JSON.parse(Widgetfly.Utils.getParameterByName("wo"));parent.postMessage(corsObj,params.origin)},Server.prototype.show=function(){this.trigger("show")},Server.prototype.hide=function(){this.trigger("hide")},Server.prototype.onClose=function(callback){console.log("Server onClose action"),callback()},Server.prototype.close=function(){console.log("Prepare server close action");var self=this;Widgetfly.Utils.each(this.events,function(key){delete self.events[key]}),this.onClose(function(){console.log("Server close action"),self.trigger("close")})},Server.prototype.setSize=function(width,height){Widgetfly.Events.trigger(window.name,"sizeChange",width,height)},Server}(this),Widgetfly.Widget=function(){var Widget=function(){this.id=Widgetfly.Utils.uniqueId("widget")};return Widgetfly.Utils.inherit(Widget,Widgetfly.Events),Widget.prototype.getId=function(){return this.id},Widget.prototype.onStart=function(callback){Widgetfly.Utils.isFunction(callback)&&this.on("onStart",callback)},Widget.prototype.start=function(){console.log("Widget.Action start");var handlers=Widgetfly.Mediator.getActionHandlers(this.id);handlers&&Widgetfly.Utils.isFunction(handlers.onStart)&&handlers.onStart()},Widget.prototype.onHide=function(callback){Widgetfly.Utils.isFunction(callback)&&this.on("onHide",callback)},Widget.prototype.hide=function(){console.log("Widget.Action hide"),Widgetfly.Utils.hasClass(this.el,"hide")||Widgetfly.Utils.addClass(this.el,"hide");var handlers=Widgetfly.Mediator.getActionHandlers(this.id);handlers&&Widgetfly.Utils.isFunction(handlers.onHide)&&handlers.onHide()},Widget.prototype.onShow=function(callback){Widgetfly.Utils.isFunction(callback)&&this.on("onShow",callback)},Widget.prototype.show=function(){console.log("Widget.Action show");var handlers;Widgetfly.Utils.hasClass(this.el,"show")||Widgetfly.Utils.addClass(this.el,"show"),handlers=Widgetfly.Mediator.getActionHandlers(this.id),handlers&&Widgetfly.Utils.isFunction(handlers.onShow)&&handlers.onShow()},Widget.prototype.onBeforeClose=function(callback){Widgetfly.Utils.isFunction(callback)&&this.on("onBeforeClose",callback)},Widget.prototype.close=function(){console.log("Widget.Action close");var r,handlers,self=this;handlers=Widgetfly.Mediator.getActionHandlers(this.id),handlers&&Widgetfly.Utils.isFunction(handlers.onBeforeClose)&&(r=handlers.onBeforeClose()),r!==!1&&Widgetfly.Mediator.unregister(this.id,function(){self.container.removeChild(self.el)})},Widget.prototype.register=function(){var nowScripts=document.getElementsByTagName("script"),cScript=nowScripts[nowScripts.length-1];Widgetfly.Mediator.register(this.id,this),cScript.setAttribute("data-id",this.id)},Widget.prototype.render=function(){var src,origin,urlOptions,iframe=document.createElement("iFrame");return origin="file:"===window.location.protocol?window.location.href:window.location.protocol+"//"+window.location.host,urlOptions={origin:origin},iframe.setAttribute("name",this.id),console.log(this.options.src),src=-1===this.options.src.indexOf("#")?this.options.src+"#":this.options.src+"&",src=src+"wo="+decodeURIComponent(JSON.stringify(urlOptions)),iframe.setAttribute("src",src),iframe},Widget}(this),Widgetfly.Panel=function(){var Panel=function(options){var appendType,selector,elms;return Widgetfly.Widget.apply(this,arguments),this.options=options,void 0===options?!1:(void 0===options.container||null===options.container?(appendType="tag",selector="body"):"."===options.container.substr(0,1)?(appendType="class",selector=options.container.replace(".","")):"#"===options.container.substr(0,1)?(appendType="id",selector=options.container.replace("#","")):(appendType="tag",selector=options.container),this.register(this.id),this.iframe=this.el=this.render(),elms="id"===appendType?window.document.getElementById(selector):"class"===appendType?Widgetfly.Utils.getElementsByClassName(selector):window.document.getElementsByTagName(selector),elms&&elms.length>0&&(this.container=elms[0]),this.container&&(options.show?Widgetfly.Utils.addClass(this.el,"show"):Widgetfly.Utils.addClass(this.el,"hide"),this.container.appendChild(this.el)),this)};return Widgetfly.Utils.inherit(Panel,Widgetfly.Widget),Panel.prototype.render=function(){return Widgetfly.Widget.prototype.render.apply(this,arguments)},Panel}(this),Widgetfly.Modal=function(){var Modal=function(options){var selector="body",elms=window.document.getElementsByTagName(selector);return Widgetfly.Widget.apply(this,arguments),this.options=options,this.container=elms[0],void 0===options?!1:(Widgetfly.Utils.getElementsByClassName("modal").length>0&&this.container.removChild(Widgetfly.Utils.getElementsByClassName("modal")),this.register(this.id),this.container&&(this.el=this.render(options),this.container.appendChild(this.el),Widgetfly.Utils.addClass(this.el,"active")),this)};return Widgetfly.Utils.inherit(Modal,Widgetfly.Widget),Modal.prototype.render=function(){var modalContent=window.document.createElement("div"),contentView=window.document.createElement("div"),viewTop=window.document.createElement("div"),spanTitle=document.createElement("span"),aClose=document.createElement("a"),iframe=Widgetfly.Widget.prototype.render.apply(this,arguments);return modalContent.setAttribute("class","modal"),spanTitle.textContent="Orz",aClose.setAttribute("href","###"),aClose.setAttribute("class","close"),aClose.textContent="x",aClose.onclick=function(){Widgetfly.Utils.removeClass(".modal","active",Widgetfly.Utils.getElementsByClassName("qt")[0])},viewTop.setAttribute("class","view-top"),viewTop.appendChild(spanTitle),viewTop.appendChild(aClose),contentView.setAttribute("class","content"),contentView.appendChild(viewTop),contentView.appendChild(iframe),modalContent.appendChild(contentView),this.iframe=iframe,modalContent},Modal.prototype.sizeChange=function(size){document.getElementsByName(this.id)[0].height=size+"px"},Modal}(this),Widgetfly.Popover=function(){var Popover=function(options){var appendType,selector,elms,content;return Widgetfly.Widget.apply(this,arguments),this.options=options,void 0===options?!1:(void 0===options.container||null===options.container?(appendType="tag",selector="body"):"."===options.container.substr(0,1)?(appendType="class",selector=options.container.replace(".","")):"#"===options.container.substr(0,1)?(appendType="id",selector=options.container.replace("#","")):(appendType="tag",selector=options.container),this.register(this.id),elms="id"===appendType?window.document.getElementById(selector):"class"===appendType?Widgetfly.Utils.getElementsByClassName(selector):window.document.getElementsByTagName(selector),elms&&elms.length>0&&(this.container=elms[0]),this.el=document.createElement("div"),this.el.setAttribute("class","popover fade in "+options.placement),content=document.createElement("div"),content.setAttribute("class","popover-content"),this.iframe=this.render(),content.appendChild(this.iframe),this.el.appendChild(content),this.container&&this.container.appendChild(this.el),this)};return Widgetfly.Utils.inherit(Popover,Widgetfly.Widget),Popover.prototype.render=function(){return Widgetfly.Widget.prototype.render.apply(this,arguments)},Popover}(this),function(){var nowScripts,param,extend=function(protoProps,staticProps){var child,Surrogate,parent=this;return child=protoProps&&Widgetfly.Utils.has(protoProps,"constructor")?protoProps.constructor:function(){return parent.apply(this,arguments)},Widgetfly.Utils.extend(child,parent,staticProps),Surrogate=function(){this.constructor=child},Surrogate.prototype=parent.prototype,child.prototype=new Surrogate,protoProps&&Widgetfly.Utils.extend(child.prototype,protoProps),child.__super__=parent.prototype,child};Widgetfly.Panel.extend=Widgetfly.Modal.extend=Widgetfly.Popover.extend=Widgetfly.Server.extend=extend,nowScripts=document.getElementsByTagName("script"),param=Widgetfly.Utils.parseUrl(nowScripts),Widgetfly.Utils.inIframe()?console.log("Now is Server initialize"):(console.log("Now is Widgets initialize"),Widgetfly.Mediator.init(),Widgetfly.Utils.isEmpty(param)||new Widgetfly.Panel(param))}(this),Widgetfly}(this);return Widgetfly});
//# sourceMappingURL=widgetfly.min.map